<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>Designing Dynamically-Featured APIs in TypeScript | Miguel&#39;s Blog</title><meta name="description" content="Or how to abuse conditional types to guarantee the availability of features at compile-time."><meta property="og:title" content="Designing Dynamically-Featured APIs in TypeScript | Miguel&#39;s Blog"><meta property="og:locale" content="en_US"><meta property="og:description" content="Or how to abuse conditional types to guarantee the availability of features at compile-time."><meta property="og:site_name" content="Miguel&#39;s Blog"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-09-24"><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/common.css"><link rel="stylesheet" href="/css/prism-onedark.css"><link rel="stylesheet" href="/css/blog.css"></head><body><header class="container full"><nav class="navbar"><div class="nav-title important"><a href="/blog">Miguel&#39;s Blog</a></div><div class="nav-links"><a href="/">Home</a> <a href="/#work">Work</a> <a href="/blog">Blog</a></div></nav></header><main class=""><div class="content"><article class="post"><header class="container"><h1 class="title">Designing Dynamically-Featured APIs in TypeScript</h1><p class="sub">September 25, 2021 ‚Ä¢ 4 min</p></header><section class="container"><p>TODO: HOOK/INTRO</p><p>Wouldn't it be nice to have the compiler guarantee to us that the features we are using are compatible and being used correctly?</p><p>This is a problem I encountered while writing <code>deno_notify</code>, a small library to send system notifications in Deno. Every platform has its own features and ways to setup notifications (e.g. macOS supports a subtitle in addition to the title and body that linux and windows have). I wanted a simple way to allow for the TypeScript API to dynamically change based on which platforms we wanted to support.</p><blockquote><p>Why can't you just use interfaces?</p></blockquote><p>It's true, one way to approach this problem is with interfaces and inheritance:</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><br>  <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token keyword">implements</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><br>  <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"woof"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">class</span> <span class="token class-name">Bird</span> <span class="token keyword">implements</span> <span class="token class-name">Animal</span> <span class="token punctuation">{</span><br>  <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"tweet"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br>  <br>  <span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"high in the sky!"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>However, once you start adding more features and want to mix-and-match them together, things can get very messy and you quickly end up with spaghetti üçù. (<em>How would you implement a single <code>walk</code> method that is available on both <code>Bird</code> and <code>Dog</code>, but is not available on a new <code>Snake</code> variant without duplicating code?</em>)</p><p>We need to find a better solution! Thankfully, TypeScript's type system gives us great tools to attack this problem.</p><p>The first thing we'll need are <strong>generics</strong>. Like in other languages, generics let us specify types (for a variable, function, etc.) when we use them rather than when we define them. If you want to learn more, the <a href="https://www.typescriptlang.org/docs/handbook/2/generics.html">TypeScript documentation will explain generics</a> better than I ever could.</p><p>With <strong>conditional types</strong>, we can branch off our resulting types based on the actual type of the generic we are given.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">IsABird<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Animal<span class="token operator">></span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">Bird</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code></pre><p>Here <code>IsABird</code> will become <code>true</code> (as a type) if the given generic type parameter <code>T</code> is a <code>Bird</code>. Following this logic, we can find all sorts of uses for conditional types.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">OnlyBirdsAllowed<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Animal<span class="token operator">></span></span> <span class="token operator">=</span> IsABird<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token boolean">true</span></span> <span class="token operator">?</span> Bird <span class="token operator">:</span> Error<span class="token punctuation">;</span></code></pre><p>Again, see the <a href="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html">TypeScript documentation on conditional types</a> for a more in-depth explanation. Hopefully you can see where I'm getting at with these, but let's continue!</p><p>Going back to our example with the interfaces, let's see how we can apply these TypeScript features. Instead of using mulitple interfaces, we can create one <code>Animal</code> class with which we can implement the shared logic using using a string check (typeguard) at runtime.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name">Animal<span class="token operator">&lt;</span>AnimalType <span class="token keyword">extends</span> <span class="token string">"bird"</span> <span class="token operator">|</span> <span class="token string">"dog"</span><span class="token operator">></span></span> <span class="token punctuation">{</span><br>  type<span class="token operator">:</span> AnimalType<span class="token punctuation">;</span><br>  <br>  <span class="token function">constructor</span><span class="token punctuation">(</span>type<span class="token operator">:</span> AnimalType<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <br>  <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"bird"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"tweet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"dog"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"woof"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Notice that the class's <code>type</code> parameter will reflect the generic <code>AnimalType</code> parameter (and vice-versa). So, calling the constructor with <code>Animal(&quot;bird&quot;)</code> will automatically infer that the <code>AnimalType</code> should be <code>&quot;bird&quot;</code>.</p><p>Implementing the bird-specific logic of the <code>fly</code> method can be done using the conditional types from earlier.</p><pre class="language-ts"><code class="language-ts">fly <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"high in the sky!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> AnimalType <span class="token keyword">extends</span> <span class="token string">"bird"</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span></code></pre><p>Bit of a mouthful but let's explain things step by step. Here, we tell the compiler that whenever the generic <code>AnimalType</code> parameter is <code>&quot;bird&quot;</code>, the <code>fly</code> property will be a function with type <code>() =&gt; void</code>. In any other instance such as when <code>type</code> is <code>&quot;dog&quot;</code>, the <code>fly</code> property will instead be of type <code>never</code>, which is TypeScript's way of saying &quot;this should never occur/&quot; (i.e. a compiler error).</p><p>So that's it! With this, the TypeScript compiler will produce an error whenever an <code>Animal</code> that is not a <code>&quot;bird&quot;</code> tries to access the <code>fly()</code> method.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> beethoven <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">"dog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>beethoven<span class="token punctuation">.</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Error: This expression is not callable.</span><br><br><span class="token keyword">const</span> bubba <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">"bird"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>bubba<span class="token punctuation">.</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "high in the sky!"</span></code></pre><p>Careful readers might point out that this does not prevent the use of the function at runtime (such as by casting to <code>any</code>). To remedy this, we can add runtime checks like we did in <code>say()</code>.</p><pre class="language-ts"><code class="language-ts">fly <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">"bird"</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Only birds can fly()"</span><span class="token punctuation">)</span><br>  <br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"high in the sky!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Type <span class="token keyword">extends</span> <span class="token string">"bird"</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">;</span></code></pre><p>This guarantees, <strong>both at compile time and at runtime</strong> that the <code>fly()</code> method can only ever be called on a bird.</p><p>Though the syntax is a bit <em>heavy</em>, it lets us create advanced APIs with specific features that are only available behind flags <strong>at compile time</strong>.</p><p>In <code>deno_notify</code>, I make use of three separate flags (using generic type parameters) for the platforms that a notification can support. With these, I can specify <strong>different features that are only available on some platforms</strong>:</p><pre class="language-ts"><code class="language-ts"><span class="token comment">/**<br> * Set the `icon`.<br> * Available on Windows and Linux.<br> * <br> * @param icon<br> */</span><br><span class="token keyword">public</span> icon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>icon<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">#verifyPlatform</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"linux"</span><span class="token punctuation">,</span> <span class="token string">"windows"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"icon"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>_icon <span class="token operator">=</span> icon<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> PlatformFeature<span class="token operator">&lt;</span>Windows <span class="token operator">|</span> Linux<span class="token punctuation">,</span> <span class="token punctuation">(</span>icon<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token operator">></span><span class="token punctuation">;</span></code></pre><details><summary>So now, different Notification objects may have different APIs based on the platforms they are meant to support.</summary><p>For example, a multi-platform notification has no access to platform-specific features. Thus, the following will not compile.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> notif <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Notification.icon() is not cross-platform, this will error</span><br>linuxNotif<span class="token punctuation">.</span><span class="token function">icon</span><span class="token punctuation">(</span><span class="token string">'/path/to/icon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>However, a notification that specifically targets linux or windows (or both) will compile and provide the &quot;extended&quot; API.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> linuxNotif <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token punctuation">{</span> linux<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Notification.icon() is now available</span><br>linuxNotif<span class="token punctuation">.</span><span class="token function">icon</span><span class="token punctuation">(</span><span class="token string">'/path/to/icon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>And a notification that targets macos will not have access to that feature either, unless <code>strictSupport</code> is disabled.</p><pre class="language-ts"><code class="language-ts"><span class="token comment">// Second parameter is `strictSupport`</span><br><span class="token keyword">const</span> linuxNotif <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token punctuation">{</span> linux<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> macos<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Notification.icon() is silently ignored on macos, but works fine on linux.</span><br>linuxNotif<span class="token punctuation">.</span><span class="token function">icon</span><span class="token punctuation">(</span><span class="token string">'/path/to/icon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></details><p>You may have also noticed the <code>this.#verifyPlatform()</code> call. This is a <a href="https://github.com/Pandawan/deno_notify/blob/platforms/ts/notification.ts#L208">somewhat complicated function</a> that verifies at runtime whether or not the current operating system is within the passed list of supported platforms. <em>(TODO: Switch link to master branch)</em></p><p>Another useful application of this is to provide <strong>different parameter hints/types based on the platform</strong>. For example, macOS has a limited set of sound files which you can use for notifications. Rather than let the user guess or have a separate enum to access them, we can propose that list of sounds for macOS users while allowing any string for other platforms.</p><pre class="language-ts"><code class="language-ts"><span class="token keyword">type</span> <span class="token class-name">MacSoundNames</span> <span class="token operator">=</span> <span class="token string">"Basso"</span> <span class="token operator">|</span> <span class="token string">"Frog"</span> <span class="token operator">|</span> <span class="token string">"Hero"</span> <span class="token operator">|</span> <span class="token comment">/* ... */</span> <span class="token operator">|</span> <span class="token string">"Ping"</span> <span class="token operator">|</span> <span class="token string">"Sosumi"</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Set the `soundName` to play with the notification.<br> *<br> * With macOS support, a list of default sounds is provided.<br> *<br> * @param soundName<br> */</span><br><span class="token keyword">public</span> soundName <span class="token operator">=</span> <span class="token punctuation">(</span><br>  soundName<span class="token operator">:</span> MacOS <span class="token keyword">extends</span> <span class="token class-name"><span class="token boolean">true</span></span> <span class="token operator">?</span> MacSoundNames <span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span><br><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">this</span><span class="token punctuation">.</span>_soundName <span class="token operator">=</span> soundName<span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>TODO: ENDING</p></section><footer class="container"><div class="center go-back"><a href="/blog">See more posts</a></div></footer></article></div></main><script defer="defer" src="/js/helper.js"></script></body></html>